<!DOCTYPE html>
<html>

<head>
    <title>VAST Challenge 2017 - Mini-Challenge 2</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
    <link rel="stylesheet" href="./src/css/switch.css" />
    <link rel="stylesheet" href="./src/css/main.css" />

    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.6/d3.min.js"></script>
    <script src="https://d3js.org/d3-selection-multi.v1.min.js"></script>
    <script src="./src/js/vector.js"></script>
    <script src="./src/js/tooltip.js"></script>
    <script src="./src/js/streamline.js"></script>
    <script src="./src/js/main.js"></script>
</head>

<body>
    <div class="tooltip"></div>
    <div class="container-fluid">
        
        <div class="row">
            <div class="col-sm-6 main-column" id="overview">
                overview
            </div>
            <div class="col-sm-6 main-column" id="simulation-map">
                <div class="row" style="border: 1px solid gray;">
                    <div class="svg-container" id="streamline-graph">
                    </div>
                </div>
                <div class="row" id="simulation-controls">
                    <button id="simToggle" onclick="toggleSimulation()" class="col-sm-6 btn btn-lg btn-primary">Click to Start Simulating Chemical Streamlines</button>
                    <div class="col-sm-3" style="vertical-align:middle;"><p style="text-align:right;">Interpolation Mode:</p></div>
                    <div class="col-sm-3 dropdown" style="text-align:center;">
                        <!--<div class="dropdown">-->
                            <button id="interpolation-mode" class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown" value="0">Filler Text
                        <span class="caret"></span></button>
                            <ul class="dropdown-menu" id="interpolation-mode-options">
                            </ul>
                        <!--</div>-->
                    </div>
                </div>  
                <div class="row" style="text-align:center">
                    <div class="col-sm-4">Using wind data from:</div>
                    <div class="col-sm-8" id="wind-indicator">---</div>
                </div>
            </div>
        </div>
        <div class="row">
            <input id="timestamp-slider" type="range" value="0" style="max-width: 90%;margin-left:5%;"/>
            <p id="current-time-stamp" style="text-align:center;">slider</p>
            <div id="step-buttons" style="text-align:center">
                <button onclick="changeTime(-1)" class="btn btn-primary"><span class="glyphicon glyphicon-chevron-left"></button>
                <input id="time-step-size" type="number" min="0" max="48" value="1" style="max-width:5%; min-width: 10px; text-align:center;">
                <button onclick="changeTime(1)" class="btn btn-primary"><span class="glyphicon glyphicon-chevron-right"></span></button>
            </div>
        </div>
    </div>
    <div id="loading-indicator" class="loading"></div>
    <script>
        let timestamps,timestamp_slider;
        let old_val;
        let start_index;
        let options = {
            verbose: true
        };

        function startWait(){
            d3.select('#loading-indicator').classed('loading',true);
        }

        function endWait(){
            d3.select('#loading-indicator').classed('loading',false);
        }

        function updateStreamLine(){
            startWait();
            let streamLineHelper = function(){
                let cur_val = timestamp_slider.node().value;
                old_val = (+old_val) || 0;
                let diff = (+cur_val || 0) - (+old_val || 0);
                let msg;
                try{
                    if(diff < 0){
                        diff *= -1;
                        for(let d = 0; d < diff; ++d){
                            challenge2.updateStreamLine(timestamps[old_val-d], -1);
                        }
                    }else if(diff > 0){
                        for(let d = 0; d < diff; ++d){
                            challenge2.updateStreamLine(timestamps[old_val+d], 1);
                        }
                    }else{
                        challenge2.updateStreamLine(timestamps[timestamp_slider.node().value], diff);
                    }
                    challenge2.updateStreamLine(timestamps[timestamp_slider.node().value], 0,true);
                }catch(err){
                    console.log(err);
                    msg = err;
                }
                old_val = cur_val;
                if(!msg){
                    d3.select('#current-time-stamp').text(timestamps[timestamp_slider.node().value]);
                }else{
                    d3.select('#current-time-stamp').text("No data found for " + timestamps[timestamp_slider.node().value]);
                }
                // challenge2.render();
                endWait();
            };

            //small delay to allow cursor to change
            setTimeout(streamLineHelper,50);
        }

        function changeTime(amount){
            let value = +(d3.select('#time-step-size').node().value) 
            let diff = value*amount;
            let curValue = +(timestamp_slider.node().value);
            console.log("start:",start_index,"new val:",curValue+diff,"step size:",diff,"raw step value",value);
            let dist_to_start = (start_index) ? (curValue - start_index) : 0;
            //ensure positive step size
            if(value < 1 /*|| value > 48*/ || (curValue+diff) >= timestamps.length ){
                alert("Please enter a positive number no larger than the max");
                d3.select('#time-step-size').node().value = 1;
                return;
            }
            //go up to the start index
            if(start_index !== undefined && start_index > curValue+diff){
                diff = -(dist_to_start);
            }
            console.log(curValue,amount,value);
            timestamp_slider.node().value = curValue + diff;
            updateStreamLine(value);
        }

        function toggleSimulation(){
            let toggle = d3.select('#simToggle');
            if(toggle.classed('btn-primary')){
                toggle.classed('btn-primary',false);
                toggle.classed('btn-warning',true);
                toggle.text("Click to Stop Simulating Chemical Streamlines");
                startSimulation();
            }else{
                toggle.classed('btn-primary', true);
                toggle.classed('btn-warning', false);
                toggle.text("Click to Start Simulating Chemical Streamlines");
                stopSimulation();
            }
        }

        function startSimulation(){
            // d3.select('#simStart').attr('disabled',true);
            // d3.select('#simEnd').attr('disabled',null);
            timestamp_slider.attr('disabled',true);

            start_index = +(timestamp_slider.node().value);

            let interpolation_dropdown = d3.select('#interpolation-mode');
            interpolation_dropdown.attr('disabled', true);
            console.log("dropdown value",interpolation_dropdown.attr('value'))
            challenge2.startSimulation(interpolation_dropdown.attr('value'),timestamps[timestamp_slider.node().value]);
            updateStreamLine();
        }

        function stopSimulation(){
            // d3.select('#simStart').attr('disabled',null);
            // d3.select('#simEnd').attr('disabled',true);
            timestamp_slider.attr('disabled',null);

            start_index = undefined;

            let interpolation_dropdown = d3.select('#interpolation-mode');
            interpolation_dropdown.attr('disabled', null);
            challenge2.stopSimulation();
            updateStreamLine();
        }

        startWait();
        let challenge2 = new Challenge2(options);
        challenge2.init().then(function(){
            timestamps = challenge2.getChemicalTimeStamps();
            timestamp_slider = d3.select('#timestamp-slider');
            timestamp_slider.attr('max',timestamps.length-1);
            timestamp_slider.on('input',updateStreamLine);
            updateStreamLine(); //set streamline graph to show data for first timestamp
            old_val = timestamp_slider.node().value;
            console.log("Ready");
            endWait();
        }); 
    </script>
</body>

</html>